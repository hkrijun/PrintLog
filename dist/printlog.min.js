/*! printlog 15-02-2018 */

function Event(t){this._sender=t,this._listeners=[],this._run_once=[]}function ReverseStr(t){return reverseString(t.substr(1))+t.charAt(0)}function StringToDate(t,e,n){var s=e.split(n),i=t.split(n),r=s.indexOf("mm"),a=s.indexOf("dd"),o=s.indexOf("yyyy"),l=parseInt(i[r])-1;return new Date(i[o],l,i[a])}function DateToString(t,e){var n=t.getMonth()+1,s=t.getDate();return n=(n>9?"":"0")+n,s=(s>9?"":"0")+s,e.replace("yyyy",t.getFullYear()).replace("mm",n).replace("dd",s)}function IsDefined(t){return void 0!==t}Event.prototype={attach:function(t,e){this._listeners.push(t),null==e&&(e=!1),this._run_once.push(e)},notify:function(t){for(var e=0;e<this._listeners.length;e++)this._listeners[e](this._sender,t),this._run_once[e]&&(this._run_once.splice(e,1),this._listeners.splice(e,1),e--)}},String.prototype.splice=function(t,e,n){return this.slice(0,t)+n+this.slice(t+Math.abs(e))},String.prototype.insert=function(t,e){return t>0?this.substring(0,t)+e+this.substring(t,this.length):e+this};var prints=new Prints,settings=new Settings,profiles=new Profiles,ui=new UIElements;function UIElements(){var t=this;t.Add=function(e){for(var n=Object.keys(e),s=0;s<n.length;s++)t[n[s]]=$(e[n[s]])}}function Prints(){var t=this;t.m_db=null,t.event_DataFileReady=new Event(t),t.event_DataFileReady.attach(function(){t.DrawLog()}),t.ForEndDesc=function(t,e){return t>0},t.ForEndAsc=function(t,e){return t<e},t.ForIterDesc=function(t){return t-1},t.ForIterAsc=function(t){return t+1},t.ReadFile=function(){$.get({cache:!1,url:settings.logfile}).then(function(e){var n=e.split(settings.new_line),s=-1;t.m_db=[];for(var i=settings.new_first?n.length-1:0,r=settings.new_first?t.ForEndDesc:t.ForEndAsc,a=settings.new_first?t.ForIterDesc:t.ForIterAsc,o=i;r(o,n.length);o=a(o))if(!n[o].startsWith(settings.comment)&&""!=n[o])if(n[o].startsWith(settings.change_mark))profiles.UpdateFromString(n[o]);else{s++;for(var l=n[o].split(settings.col_delimiter),_={},d=0;d<settings.data.length;d++)if(void 0!==l[settings.data[d].col])if(_[settings.data[d].name]=l[settings.data[d].col],void 0!==settings.data[d].dateFormat)_[settings.data[d].name]=StringToDate(_[settings.data[d].name],settings.data[d].dateFormat,settings.date_delimiter),_[settings.data[d].name].setMilliseconds(n.length-o);else if(IsDefined(settings.data[d].hasSubItems)&&settings.data[d].hasSubItems){var u=_[settings.data[d].name].split(settings.col_subdelimiter);_[settings.data[d].name]=[];for(var g=0;g<u.length;g++)_[settings.data[d].name].push(u[g].split(settings.rule_pointer))}_.profile=profiles.GetCurrentID(),_._hard_id=s,t.m_db.push(_)}t.event_DataFileReady.notify()})},t.DrawLog=function(){var e="",n=t.Sort();for(var s=0;s<n.length;s++){var i="";if(0==s||n[s].profile!=n[s-1].profile){var r=e.lastIndexOf("entry row");r>-1&&(e=e.insert(r,"nth_last "));var a=profiles.GetByID(n[s].profile),o=Object.keys(a);e+='<div class="row row-eq-height no-gutters sub_header_container"><div class="col-sm-12 sub_header">'+a.Profile;for(var l=0;l<o.length;l++)if("Profile"!=o[l]){e+='<div class="sub_header_item"><span class="header_item_key">'+o[l]+"</span>";var _=a[o[l]].split(settings.col_change_delimiter);_.forEach(function(t,n){e+='<span class="header_item_val_'+(_.length-n)+'">'+t+"</span>"}),e+="</div>"}e+="</div></div>",i=" nth_first"}e+='<div class="entry row row-eq-height no-gutters '+(s%2?"nth_odd":"nth_even")+i+'" id="entry-id_'+n[s]._hard_id+'">';for(var d=0;d<settings.data.length;d++){if(e+='<div class="'+settings.data[d].class+" "+settings.data[d].name+'"><span class="'+settings.data[d].name+'_bg"></span><div class="'+settings.data[d].name+'_val entry_val">',IsDefined(n[s][settings.data[d].name])&&IsDefined(settings.data[d].hasSubItems)&&settings.data[d].hasSubItems)for(var u=n[s][settings.data[d].name],g=0;g<u.length;g++)e+='<div class="sub_item_container"><span class="sub_item_key">'+u[g][0]+'</span><span class="sub_item_val">'+u[g][1]+"</span></div>";else{var c=void 0!==n[s][settings.data[d].name]?n[s][settings.data[d].name]:"<br />";void 0!==settings.data[d].dateFormat&&(c=DateToString(c,settings.ui_date_format)),e+=c}e+="</div></div>"}e+="</div>"}var p=e.lastIndexOf("entry row");p>-1&&(e=e.insert(p,"nth_last ")),$(settings.html_log).children(".entry").remove(),$(settings.html_log).prepend(e),$(settings.html_log).on("click",".entry",function(e){t.EntryClick(this)})},t.EntryClick=function(e){var n=parseInt(e.id.split("_")[1]),s=t.m_db[n];ui.entry_input_date.val(DateToString(s.date,settings.ui_date_format)),ui.entry_input_short_file.val(s.short_file),ui.entry_input_file.val(s.file),ui.entry_input_settings.children(".setting").remove();for(var i="",r=IsDefined(s.settings)?s.settings.length:0,a=0;a<r;a++)i+='<div class="setting"><span>'+s.settings[a][0]+"</span><span>"+s.settings[a][1]+"</span></div>";ui.entry_input_settings.prepend(i),ui.entry_input_settings.off("click",".setting"),ui.entry_input_settings.on("click",".setting",function(t){t.stopPropagation(),ui.entry_input_settings_dropdown.addClass("open"),ui.entry_input_settings_dropdown.trigger("show.bs.dropdown");var e=$(this).children("span"),n=e[0].innerHTML,s=e[1].innerHTML;ui.entry_input_settingsKey.val(n),ui.entry_input_settingsValue.val(s),ui.entry_input_settingsAdd.val("Update setting")})},t.Sort=function(){for(var e=[t.m_db[0]],n=settings.sort_desc?t.ForEndDesc:t.ForEndAsc,s=settings.sort_desc?t.ForIterDesc:t.ForIterAsc,i=void 0===settings.GetSortByData().dateFormat,r=1;r<t.m_db.length;r++){for(var a=settings.sort_desc?e.length-1:0;n(a,e.length);a=s(a)){var o=t.m_db[r][settings.sort_by],l=e[a][settings.sort_by];if(i&&(o=o.toLowerCase(),l=l.toLowerCase()),o>l)break}e.splice(a,0,t.m_db[r])}return e}}function Profiles(){var t=this;t.m_profiles=[],t.m_profiles[0]={Profile:"Default"},t.UpdateFromString=function(e){var n=e.split(settings.col_delimiter);n[0]=n[0].substr(1);for(var s=n[1].split(settings.col_subdelimiter),i={},r=0;r<s.length;r++){var a=s[r].split(settings.rule_pointer);i[a[0]]=a[1]}void 0===i.Profile&&(i.Profile=t.GetCurrent().Profile),t.m_profiles.push(i)},t.GetCurrentID=function(){return t.m_profiles.length-1},t.GetCurrent=function(){return t.m_profiles[t.GetCurrentID()]},t.GetByID=function(e){return t.m_profiles[e]}}function Settings(){this.logfile="log.txt",this.new_first=!0,this.col_delimiter=":",this.col_subdelimiter="|",this.col_change_delimiter="->",this.comment="#",this.setting_delimiter=";",this.rule_pointer="=",this.new_line="\r\n",this.change_mark="+",this.date_delimiter="-",this.ui_date_format="dd-mm-yyyy",this.data=[{col:2,name:"date",class:"col-sm-1",dateFormat:"dd-mm-yyyy"},{col:0,name:"short_file",class:"col-sm-1"},{col:1,name:"file",class:"col-sm-5"},{col:3,name:"settings",class:"col-sm-5",hasSubItems:!0}],this.html_log=".log_lines",this.sort_by="date",this.sort_desc=!1,this.GetSortByData=function(){for(var t=0;t<this.data.length;t++)if(this.data[t].name==this.sort_by)return this.data[t]}}$(document).ready(function(){ui.Add({entry_input_date:"#entry_input_date",entry_input_short_file:"#entry_input_short_file",entry_input_file:"#entry_input_file",entry_input_add_settings:"#entry_input_add_setting",entry_input_settingsKey:"#entry_input_settingsKey",entry_input_settingsValue:"#entry_input_settingsValue",entry_input_settingsAdd:"#entry_input_settingsAdd",entry_input_settings:".entry_input .settings",entry_input_settings_dropdown:".entry_input .settings .dropdown",input_settings_new:".entry_input .settings .form-inline"}),ui.entry_input_settings_dropdown.on("show.bs.dropdown",function(){ui.entry_input_add_settings.html('Hide <span class="glyphicon glyphicon-triangle-top"></span>'),ui.entry_input_settingsAdd.val("Add setting")}),ui.entry_input_settings_dropdown.on("hide.bs.dropdown",function(){ui.entry_input_add_settings.html('Add <span class="glyphicon glyphicon-triangle-bottom"></span>')}),ui.entry_input_add_settings.on("click",function(){ui.entry_input_settingsKey.val(""),ui.entry_input_settingsValue.val("")}),prints.ReadFile()});